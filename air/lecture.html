<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=980, user-scalable=no" />
        [<meta name="description" content="(#DESCRIPTIF_SITE_SPIP|couper{150}|textebrut)" />]

        <title>[(#NOM_SITE_SPIP|textebrut)]</title>

        <INCLURE{fond=inclure/head} />

        <script type="text/javascript" src="#CHEMIN{js/jquery.nicescroll.min.js}"></script>
    </head>

    <body>
<!-- ID/NOM AUTEUR-->

    <!-- Le cache est a zero pour pouvoir récupérer l'id de l'auteur connecté-->
    #CACHE{0}

    <!-- ID et nom de l'auteur connecté -->
    #SET{var_id_auteur,#SESSION{id_auteur}}
    #SET{var_nom_auteur,#SESSION{nom}}



[(#REM) Les deux boucles suivantes servent à récupérer les identifiants et titres des rubriques qui nous intérsseront]
[(#REM) dans la page. Il suffira alors de rappeler les variables ainsi sauvées.]
<BOUCLE_principale(RUBRIQUES){id_rubrique}>
    [(#ID_PARENT|setenv{id_rubrique_annee_voulue})]
    [(#ID_RUBRIQUE|setenv{id_rubrique_histoire_voulue})]
</BOUCLE_principale>
<BOUCLE_NOM_ANNEE(RUBRIQUES){id_rubrique=#ENV{id_rubrique_annee_voulue}}{tout}>
    [(#TITRE|setenv{annee_voulue})]
</BOUCLE_NOM_ANNEE>
<!-- on veut l'année : #ENV{annee_voulue} -->
<!-- on veut l'id de la rubrique de l'année : #ENV{id_rubrique_annee_voulue} -->
<!-- on veut l'id de l'histoire : #ENV{id_rubrique_histoire_voulue} -->

<script type="text/javascript">
    /*
        pageCourante :
        - 1 signifie Prologue-chapitre_1
        - 2 signifie chapitre_2-chapitre_3
        - 3 signifie chapitre_4-chapitre_5
     */
    let pageCourante=1;

    [(#REM) Tentative de stocker le contenu des textes des chapitres dans des constantes js.]
    <BOUCLE_prologue2(ARTICLES){id_rubrique==#ENV{id_rubrique_annee_voulue}}{titre LIKE prologue}>
    const textePrologue = "[(#TEXTE|echapper_tags|attribut_html)]";
    </BOUCLE_prologue2>

    <BOUCLE_chapitre1(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{0,1}>
    const texteChapitre1 = "[(#DESCRIPTIF|echapper_tags|attribut_html)]";
    </BOUCLE_chapitre1>

    <BOUCLE_chapitre2(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{1,1}>
    const texteChapitre2 = "[(#DESCRIPTIF|echapper_tags|attribut_html)]";
    </BOUCLE_chapitre2>

    <BOUCLE_chapitre3(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{2,1}>
    const texteChapitre3 = "[(#DESCRIPTIF|echapper_tags|attribut_html)]";
    </BOUCLE_chapitre3>

    <BOUCLE_chapitre4(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{3,1}>
    const texteChapitre4 = "[(#DESCRIPTIF|echapper_tags|attribut_html)]";
    </BOUCLE_chapitre4>

    <BOUCLE_chapitre5(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{4,1}>
    const texteChapitre5 = "[(#DESCRIPTIF|echapper_tags|attribut_html)]";
    </BOUCLE_chapitre5>

    /**
     * Reconvertit les caractères échappées à leur apparence normale.
     * En théorie, on ne devrait pas subir de failles d'injection de code car le code reçu est protégé et encapsulé par
     * SPIP.
     * MAIS ON VA QUAND MÊME SUPPRIMER AU CAS OÙ LES BALISES DE SCRIPT!
     * @param input
     * @returns {string}
     */
    function htmlDecode(input) {
        // D'abord on décode.
        const texteParse = new DOMParser().parseFromString(input, "text/html");
        let codeHTML = texteParse.documentElement.textContent;

        // Puis on créé un vrai élément HTML mais bidon.
        const divTemporaire = document.createElement('div');
        divTemporaire.innerHTML = codeHTML;
        // On parcourt tous les éventuels éléments <script> que l'on videra de leur substance.
        const scriptsDansDiv = divTemporaire.getElementsByTagName('script');
        let i = scriptsDansDiv.length;
        while (i--) {
            scriptsDansDiv[i].parentNode.removeChild(scriptsDansDiv[i]);
        }
        return divTemporaire.innerHTML;
    }

    /**
     * Affiche le contenu textuel dans les pages lorsqu'un utilisateur souhaite en tourner une.
     */
    function afficherPage(){
        switch (pageCourante){
            case 1:{
                const pageGauche = document.getElementById('page-gauche-livre');
                pageGauche.innerHTML = htmlDecode(textePrologue);
                const pageDroite = document.getElementById('page-droite-livre');
                pageDroite.innerHTML = htmlDecode(texteChapitre1);
                break;
            }
            case 2:{
                const pageGauche = document.getElementById('page-gauche-livre');
                pageGauche.innerHTML = htmlDecode(texteChapitre2);
                const pageDroite = document.getElementById('page-droite-livre');
                pageDroite.innerHTML = htmlDecode(texteChapitre3);
                break;
            }
            case 3:{
                const pageGauche = document.getElementById('page-gauche-livre');
                pageGauche.innerHTML = htmlDecode(texteChapitre4);
                const pageDroite = document.getElementById('page-droite-livre');
                pageDroite.innerHTML = htmlDecode(texteChapitre5);
                break;
            }
            default:
                break
        }
    }

    /**
     * Demande d'affichage de la page précédente du livre. Appel provenant du bouton précédent en haut du livre.
     */
    function tournerPagePrecedente(){
        if(pageCourante>1){
            pageCourante--;
            afficherPage();
        }
    }


    /**
     * Demande d'affichage de la page suivante du livre. Appel provenant du bouton suivant en haut du livre.
     */
    function tournerPageSuivante(){
        if(pageCourante<3){
            pageCourante++;
            afficherPage();
        }
    }
</script>


<!-- TOOLTIP -->
<div id="liste-tooltip">
</div>


<!-- ELEMENTS GRAPHIQUES-->
<div id="book-top-left"><img src="#CHEMIN{img/global/border-book-top-left.png}" width="14" height="16" /></div>
<div id="book-top-right"><img src="#CHEMIN{img/global/border-book-top-right.png}" width="14" height="16" /></div>
<!--
<div id="book-bottom-left"><img src="#CHEMIN{img/global/border-book-bottom-left.png}" width="14" height="16" /></div>
<div id="book-bottom-right"><img src="#CHEMIN{img/global/border-book-bottom-right.png}" width="14" height="16" /></div>
-->

<div id="book-middle-top"><img src="#CHEMIN{img/global/book-middle-top.png}" width="300" height="6" /></div>
<!--
<div id="book-middle-bottom"><img src="#CHEMIN{img/global/book-middle-bottom.png}" width="300" height="5" /></div>
-->
<div class="stitches">
<div class="stitches-inner"><img src="#CHEMIN{img/global/stitches.png}" width="5" height="86" /></div>
<div class="stitches-inner"><img src="#CHEMIN{img/global/stitches.png}" width="5" height="86" /></div>
<div class="stitches-inner"><img src="#CHEMIN{img/global/stitches.png}" width="5" height="86" /></div>
</div>

<!-- PAGE SUIVANT PRECEDENTE-->
<div  class="bt-next-prev" id="bt-prev">
    <img
            src="#CHEMIN{img/global/bt-retour.png}"
            onmouseover="this.src='#CHEMIN{img/global/bt-retour-hover.png}';"
            onmouseout="this.src='#CHEMIN{img/global/bt-retour.png}';"
            onclick="tournerPagePrecedente();"
            width="54" height="54" />
</div>
<div  class="bt-next-prev" id="bt-next">
    <img
            src="#CHEMIN{img/global/bt-next.png}"
            onmouseover="this.src='#CHEMIN{img/global/bt-next-hover.png}';"
            onmouseout="this.src='#CHEMIN{img/global/bt-next.png}';"
            onclick="tournerPageSuivante();"
            width="54" height="54" />
</div>

<!-- RETOUR HOME -->
<div id="retour-home">
    <a href="#URL_SITE_SPIP">
        <img
                src="#CHEMIN{img/lecture/bt-home.png}"
                onmouseover="this.src='#CHEMIN{img/lecture/bt-home-hover.png}';"
                onmouseout="this.src='#CHEMIN{img/lecture/bt-home.png}';"
                width="60" height="60" />
    </a>
</div>


[(#REM) Apparemment, le but de ce squelette est de donner l'apparence d'un livre dont chaque page serait un des]
[(#REM) chapitres du cadavre exquis (dont on a pu récupérer l'id juste avant dans le code).]
[(#REM) On commencerait par afficher le prologue sur la page gauche et le chapitre 1 sur la page droite.]
[(#REM) Deux flèches dans l'interface permettent de naviguer dans les chapitres.]
[(#REM) Un premier clic sur « suivant » remplacera le texte du prologue par la partie 2 tandis que la page de]
[(#REM) droite recevra le chapitre 3. Etc... pour les autres utilisations des flèches précédentes et suivantes.]
    <!-- BOOK -->
    <div id="livre" style="display:inline-block;">
        <div id="global-spacer"></div>
        <div id="contenuPages" style="">
            <div id="page-gauche-livre" style="padding-left: 25px;padding-top: 50px;padding-right: 30px;width: 44%;float: left;">
                [(#REM) Au départ, la page de gauche contient le prologue.]
                <BOUCLE_prologue(ARTICLES){id_rubrique==#ENV{id_rubrique_annee_voulue}}{titre LIKE prologue}>
                #TEXTE
                </BOUCLE_prologue>
            </div>

            <div id="page-droite-livre" style="padding-left: 25px;padding-top: 50px;padding-right: 30px;width: 44%;float: right;">
                [(#REM) Au départ, la page de droite contient le chapitre 1.]
                <BOUCLE_chapitre_1(ARTICLES){id_rubrique==#ENV{id_rubrique_histoire_voulue}}{par date}{0,1}>
                #DESCRIPTIF
                </BOUCLE_chapitre_1>
            </div>
        </div>
    </div>

</body>
</html>